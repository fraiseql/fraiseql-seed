name: SBOM Generation

# Generate Software Bill of Materials (SBOM) for global supply chain security compliance
# (US EO 14028, EU NIS2/CRA, PCI-DSS 4.0, ISO 27001)
# Runs on releases and can be manually triggered

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate SBOM for (e.g., 0.1.0)'
        required: true
        type: string
      package:
        description: 'Package to generate SBOM for'
        required: true
        type: choice
        options:
          - fraiseql-uuid
          - fraiseql-data
          - both

permissions:
  contents: write  # Required to upload release assets
  id-token: write  # Required for Cosign keyless signing

jobs:
  generate-sbom:
    name: Generate & Sign SBOM
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'both' && fromJSON('["fraiseql-uuid", "fraiseql-data"]') || fromJSON(format('["{0}"]', github.event.inputs.package))) || fromJSON('["fraiseql-uuid", "fraiseql-data"]') }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install dependencies
      run: |
        uv venv
        uv pip install cyclonedx-bom pip-licenses

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          # Fallback to package version from pyproject.toml
          VERSION=$(uv run python -c "import tomllib; f = open('packages/${{ matrix.package }}/pyproject.toml', 'rb'); data = tomllib.load(f); print(data['project']['version']); f.close()")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generating SBOM for ${{ matrix.package }} version: $VERSION"

    - name: Read package metadata
      id: metadata
      run: |
        PACKAGE_DIR="packages/${{ matrix.package }}"

        # Extract metadata from pyproject.toml
        COMPONENT_NAME=$(uv run python -c "import tomllib; f = open('$PACKAGE_DIR/pyproject.toml', 'rb'); data = tomllib.load(f); print(data['project']['name']); f.close()")
        DESCRIPTION=$(uv run python -c "import tomllib; f = open('$PACKAGE_DIR/pyproject.toml', 'rb'); data = tomllib.load(f); print(data['project']['description']); f.close()")

        echo "component_name=$COMPONENT_NAME" >> $GITHUB_OUTPUT
        echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

        echo "Package: $COMPONENT_NAME"
        echo "Description: $DESCRIPTION"

    - name: Install package dependencies
      run: |
        cd packages/${{ matrix.package }}
        uv pip install -e .

    - name: Generate SBOM (CycloneDX JSON)
      run: |
        cd packages/${{ matrix.package }}

        echo "=== Generating CycloneDX SBOM ==="
        cyclonedx-py environment \
          --pyproject pyproject.toml \
          --mc-type library \
          --sv 1.5 \
          --of JSON \
          -o ../../${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json \
          || {
            echo "âŒ CycloneDX generation failed"
            exit 1
          }

        echo "âœ… SBOM generated successfully"

    - name: Enhance SBOM with metadata
      run: |
        # Add component metadata to SBOM
        cat > enhance_sbom.py << 'EOF'
import json
import sys

sbom_file = sys.argv[1]
component_name = sys.argv[2]
version = sys.argv[3]
description = sys.argv[4]

with open(sbom_file, 'r') as f:
    sbom = json.load(f)

# Enhance metadata component
if 'metadata' in sbom and 'component' in sbom['metadata']:
    sbom['metadata']['component'].update({
        'name': component_name,
        'version': version,
        'description': description,
        'type': 'library',
        'licenses': [{'license': {'id': 'MIT'}}],
        'externalReferences': [
            {
                'type': 'website',
                'url': 'https://github.com/fraiseql/fraiseql-seed'
            },
            {
                'type': 'vcs',
                'url': 'https://github.com/fraiseql/fraiseql-seed'
            },
            {
                'type': 'issue-tracker',
                'url': 'https://github.com/fraiseql/fraiseql-seed/issues'
            }
        ]
    })

with open(sbom_file, 'w') as f:
    json.dump(sbom, f, indent=2)

print(f"âœ… Enhanced SBOM metadata for {component_name} v{version}")
EOF

        uv run python enhance_sbom.py \
          "${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json" \
          "${{ steps.metadata.outputs.component_name }}" \
          "${{ steps.version.outputs.version }}" \
          "${{ steps.metadata.outputs.description }}"

    - name: Validate SBOM
      run: |
        echo "=== Validating SBOM Schema ==="
        uv run python -c "
import json
sbom_file = '${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json'
with open(sbom_file) as f:
    sbom = json.load(f)
    assert sbom['bomFormat'] == 'CycloneDX'
    assert sbom['specVersion'] == '1.5'
    assert 'components' in sbom
    print(f'âœ… SBOM validation passed')
    print(f'   Components: {len(sbom.get(\"components\", []))}')
    print(f'   Format: CycloneDX {sbom[\"specVersion\"]}')
"

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    - name: Sign SBOM with Cosign (keyless)
      run: |
        SBOM_FILE="${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json"

        cosign sign-blob --yes \
          "$SBOM_FILE" \
          --output-signature "$SBOM_FILE.sig" \
          --output-certificate "$SBOM_FILE.pem"

        echo "âœ… SBOM signed with Cosign (keyless)"
        echo "   Signature: $SBOM_FILE.sig"
        echo "   Certificate: $SBOM_FILE.pem"

    - name: Generate SHA256 checksums
      run: |
        SBOM_FILE="${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json"

        sha256sum "$SBOM_FILE" > "$SBOM_FILE.sha256"
        echo "âœ… SHA256 checksum generated"

    - name: Create SBOM artifact bundle
      run: |
        SBOM_FILE="${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json"

        mkdir -p sbom-artifacts
        cp "$SBOM_FILE" sbom-artifacts/
        cp "$SBOM_FILE.sig" sbom-artifacts/
        cp "$SBOM_FILE.pem" sbom-artifacts/
        cp "$SBOM_FILE.sha256" sbom-artifacts/

        # Create README for verification
        cat > sbom-artifacts/README.md << EOF
# ${{ matrix.package }} SBOM Verification

## Files Included

- \`$SBOM_FILE\` - CycloneDX SBOM (JSON format)
- \`$SBOM_FILE.sig\` - Cosign signature (keyless)
- \`$SBOM_FILE.pem\` - Cosign certificate
- \`$SBOM_FILE.sha256\` - SHA256 checksum

## Verify SBOM Integrity

### 1. Verify SHA256 Checksum
\`\`\`bash
sha256sum -c $SBOM_FILE.sha256
\`\`\`

### 2. Verify Cosign Signature
\`\`\`bash
cosign verify-blob \\
  --signature $SBOM_FILE.sig \\
  --certificate $SBOM_FILE.pem \\
  --certificate-identity-regexp "https://github.com/fraiseql/fraiseql-seed" \\
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \\
  $SBOM_FILE
\`\`\`

### 3. Validate SBOM Schema
\`\`\`bash
pip install cyclonedx-bom
cyclonedx-py validate --input-file $SBOM_FILE
\`\`\`

## SBOM Compliance

This SBOM complies with global supply chain security standards:
- ðŸ‡ºðŸ‡¸ **US Executive Order 14028** (May 2021) - Software supply chain security
- ðŸ‡ªðŸ‡º **EU NIS2 Directive** & **Cyber Resilience Act** - Supply chain transparency
- ðŸ’³ **PCI-DSS 4.0** (Requirement 6.3.2) - Software component inventory
- ðŸŒ **ISO 27001:2022** (Control 5.21) - ICT supply chain security
- **CycloneDX 1.5 Specification** - OWASP SBOM standard
- **NIST SP 800-161** - Cyber Supply Chain Risk Management

## For Procurement & Security Teams

This SBOM provides:
1. âœ… Complete dependency inventory
2. âœ… License compliance information
3. âœ… Cryptographic integrity verification (SHA256 + Cosign)
4. âœ… Machine-readable format (CycloneDX JSON)
5. âœ… Vulnerability database integration (Package URLs)

## Questions?

For SBOM-related questions or procurement inquiries:
- Repository: https://github.com/fraiseql/fraiseql-seed
- Issues: https://github.com/fraiseql/fraiseql-seed/issues
EOF

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v6
      with:
        name: sbom-${{ matrix.package }}-${{ steps.version.outputs.version }}
        path: sbom-artifacts/
        retention-days: 90

    - name: Attach SBOM to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json
          ${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json.sig
          ${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json.pem
          ${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        SBOM_FILE="${{ steps.metadata.outputs.component_name }}-${{ steps.version.outputs.version }}-sbom.json"

        echo "## ðŸ“‹ SBOM Generation Complete - ${{ matrix.package }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Package**: ${{ steps.metadata.outputs.component_name }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Format**: CycloneDX 1.5 (JSON)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Signed**: Cosign keyless (Sigstore)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Compliance**: US EO 14028, EU NIS2/CRA, PCI-DSS 4.0, ISO 27001" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Count components
        COMPONENT_COUNT=$(uv run python -c "import json; f = open('$SBOM_FILE'); data = json.load(f); print(len(data.get('components', []))); f.close()")
        echo "ðŸ“¦ **Total Components**: $COMPONENT_COUNT" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "SBOM artifacts available in workflow artifacts section" >> $GITHUB_STEP_SUMMARY
